---
# Night Agent Configuration
base_branch: master
max_retries: 2
continue_on_failure: true
screenshots: true
feature_timeout: 60

# Visual Quality Gate (v1.6.0)
visual_gate_enabled: true
visual_gate_threshold: 0.7
bundle_id: com.StudioNext.SoundScape

# Action Logging (v1.6.0)
action_logging: true

# Deep Quality Mode (v1.10.0)
deep_quality_mode: true
deep_quality_max_retries: 5
deep_quality_visual_threshold: 0.85
deep_quality_min_test_coverage: 0.7
deep_quality_review_gate: true
deep_quality_checkpoints:
  - post_entity
  - post_repository
  - post_viewmodel
  - post_view
  - post_integration
---

# Feature Queue: Sleep Recording & Snore Analysis

Generated by NightPrep Agent on 2026-02-17

## Overview

This batch replaces the Alarms tab with a comprehensive Sleep Recording & Snore Analysis feature. Users can record their sleep audio overnight, get automatic snoring/loud-sound detection, view a visual timeline report with a Snore Score, listen to highlighted moments, browse recording history, and export data for their doctor. The feature is inspired by SnoreLab (Snore Score + timeline), Pillow (event detection), and SnoreClock (FFT timeline visualization).

## Global Requirements

The following requirements apply to ALL features in this batch:

- **Translations**: Every user-facing string must use `String(localized:)` or `LocalizedStringKey` and be added to the existing `Localizable.xcstrings` file at `SoundScape/Resources/Localizable.xcstrings`. The source language is English.
- **Unit Tests**: All new or modified business logic must have corresponding unit tests. Existing tests in `SoundScape/Tests/` must continue to pass. Test files follow the pattern `SoundScape/Tests/<ServiceName>Tests.swift`.
- **Build Verification**: The project must build successfully after each feature: `cd SoundScape && xcodebuild -scheme SoundScape -destination 'platform=iOS Simulator,name=iPhone 17 Pro' build`
- **Medical Disclaimer**: Any screen showing analysis results must include: "SoundScape is not a medical device. Consult a healthcare professional for sleep apnea diagnosis." This text must be localized.
- **Dark Theme**: All new views must follow the app's existing dark theme patterns and styling.

## Features

### 1. Sleep Recording Domain Entities

Create the core data models that all sleep recording features depend on. These entities represent a recording session, detected sound events within a session, and supporting types.

**User Story:**
As a developer, I need well-defined data models for sleep recordings and sound events so that all features share a consistent data foundation.

**What to create:**

File: `Sources/Domain/Entities/SleepRecording.swift`

1. **`SleepRecording`** struct (Identifiable, Codable, Equatable):
   - `id: UUID`
   - `date: Date` (when recording started)
   - `endDate: Date` (when recording stopped)
   - `duration: TimeInterval` (total recording length)
   - `fileURL: URL` (path to the audio file on disk)
   - `events: [SoundEvent]` (detected events, empty until analysis runs)
   - `decibelSamples: [Float]` (1 sample per second, for timeline chart)
   - `averageDecibels: Float`
   - `peakDecibels: Float`
   - `snoreScore: Int` (0-100, calculated after analysis)
   - Computed: `formattedDuration` (e.g., "7h 32m"), `formattedDate` (e.g., "Feb 17, 2026"), `formattedTimeRange` (e.g., "11:30 PM - 7:02 AM"), `snoringMinutes` (sum of snoring event durations), `eventCount`, `snoreScoreCategory` (quiet/moderate/loud)

2. **`SoundEvent`** struct (Identifiable, Codable, Equatable):
   - `id: UUID`
   - `timestamp: TimeInterval` (offset from recording start in seconds)
   - `duration: TimeInterval`
   - `type: SoundEventType`
   - `peakDecibels: Float`
   - `averageDecibels: Float`
   - Computed: `formattedTimestamp` (e.g., "2:34 AM"), `formattedDuration` (e.g., "12s")

3. **`SoundEventType`** enum (String, Codable, CaseIterable):
   - Cases: `snoring`, `loudSound`, `talking`, `silence`
   - Properties: `displayName` (localized), `icon` (SF Symbol name), `color` (SwiftUI Color — orange for snoring, red for loud, blue for talking, gray for silence)

4. **`RecordingStatus`** enum:
   - Cases: `idle`, `recording`, `analyzing`, `complete`

**Acceptance Criteria:**
- All entities conform to `Codable`, `Identifiable`, `Equatable`
- All computed properties return correctly formatted values
- `SoundEventType` colors and icons are defined
- Unit tests verify: encoding/decoding round-trip, computed property calculations (snoringMinutes, snoreScoreCategory thresholds), formattedDuration for various durations
- All display strings use `String(localized:)`

**Priority:** 1
**Dependencies:** None

---

### 2. Sleep Recording Service - Core Audio Recording

Create the central service that manages audio recording through the night using AVAudioRecorder. This service handles microphone permissions, audio session configuration, recording lifecycle, and real-time decibel metering.

**User Story:**
As a user, I want to record audio while I sleep so that the app can analyze my sleep sounds for snoring and other events.

**What to create:**

File: `Sources/Data/Services/SleepRecordingService.swift`

**`SleepRecordingService`** (@Observable, @MainActor, final class):

*Properties (observable):*
- `status: RecordingStatus` (idle, recording, analyzing, complete)
- `currentDecibels: Float` (real-time level, updated 10x/second)
- `peakDecibels: Float` (highest level in this session)
- `recordingDuration: TimeInterval` (elapsed time)
- `recordings: [SleepRecording]` (all saved recordings, loaded from disk)
- `currentRecording: SleepRecording?` (the recording being viewed/just completed)

*Recording methods:*
- `startRecording()` — requests mic permission if needed, configures AVAudioSession for `.playAndRecord` with `.defaultToSpeaker` and `.mixWithOthers` (so ambient SoundScape sounds keep playing), creates AVAudioRecorder with AAC/m4a format (mono, 22050 Hz, 32kbps for ~15MB/night), enables metering, starts a Timer for decibel sampling
- `stopRecording()` — stops recorder, saves metadata, triggers analysis status
- `requestMicrophonePermission()` — wraps `AVAudioSession.requestRecordPermission`
- `deleteRecording(_:)` — removes audio file + metadata from disk

*Metering:*
- Timer fires 10x/second to update `currentDecibels` via `recorder.averagePower(forChannel:)`
- Every 1 second, append the average of the last 10 samples to a `decibelSamples` array (for timeline, memory-efficient)
- Track `peakDecibels` across the session
- Update `recordingDuration` from recorder's `currentTime`

*Audio Session:*
- Before recording: save current audio session category, reconfigure to `.playAndRecord` with `.defaultToSpeaker` and `.mixWithOthers`
- After recording: restore previous category (`.playback` for normal SoundScape operation)
- Handle interruptions (phone calls, Siri) by pausing/resuming recording

*Persistence:*
- Audio files stored in `Documents/SleepRecordings/` directory
- Recording metadata stored as JSON array in `Documents/sleep_recordings.json`
- Follow the same persistence pattern as `AlarmService` (load in init, save after mutations)

*Registration:*
- Add `@State private var sleepRecordingService = SleepRecordingService()` in `SoundScapeApp.swift`
- Add `.environment(sleepRecordingService)` to the environment chain

**Acceptance Criteria:**
- Service initializes and loads existing recordings from disk
- `startRecording()` creates an m4a file and begins recording
- Real-time decibel metering updates `currentDecibels` at 10Hz
- `decibelSamples` array grows by 1 entry per second
- `stopRecording()` saves the audio file and metadata to disk
- Audio session is reconfigured for recording and restored after
- Ambient SoundScape sounds continue playing during recording
- `deleteRecording()` removes both the audio file and metadata
- Microphone permission is requested before first recording
- Unit tests verify: persistence round-trip, recording state transitions, file path generation, audio session category changes
- All strings localized

**Priority:** 1
**Dependencies:** Feature 1

---

### 3. Replace Alarms Tab with Sleep Recording Tab

Replace the Alarms tab in ContentView with a Sleep Recording tab. Create the main SleepRecordingView scaffold that will host recording controls and history.

**User Story:**
As a user, I want a Sleep Recording tab in the app so I can easily access the sleep recording feature from the main navigation.

**What to change:**

1. **`ContentView.swift`** — Tab enum and TabView:
   - Rename enum case `.alarms` to `.sleepRecording`
   - Update icon to `"mic.badge.waveform"` (SF Symbol combining mic + waveform, available iOS 17+; fall back to `"waveform.badge.mic"` if needed, or `"mic.fill"`)
   - Update `localizedName` to `"Sleep Rec"`
   - Replace `AlarmsView()` with `SleepRecordingView()` in TabView
   - Remove `@Environment(AlarmService.self) private var alarmService`
   - Remove `@Bindable var alarmService = alarmService`
   - Remove `.fullScreenCover(item: $alarmService.ringingAlarm)` for alarm ringing
   - Add `@Environment(SleepRecordingService.self) private var sleepRecordingService`

2. **`SoundScapeApp.swift`**:
   - Keep `AlarmService` instantiation for now (other parts may reference it) but it's no longer needed in ContentView
   - Ensure `SleepRecordingService` is in the environment chain (done in Feature 2)

3. **New file: `Sources/Presentation/SleepRecording/Views/SleepRecordingView.swift`**:
   - Basic NavigationStack with title "Sleep Recording"
   - Access `SleepRecordingService` from environment
   - When `recordings` is empty: show `ContentUnavailableView` with icon `"mic.badge.waveform"`, title "No Recordings", description "Tap the record button to capture your sleep sounds and discover snoring patterns"
   - When `recordings` is not empty: show placeholder text "Recording history will appear here" (full UI comes in later features)
   - Large circular record button at the bottom of the screen (just visual for now, functionality in Feature 4)

4. **Update `project.pbxproj`**:
   - Add new `SleepRecording` group under `Presentation` with `Views` subgroup
   - Add `SleepRecordingView.swift` file reference and build phase entry

**Acceptance Criteria:**
- Tab bar shows "Sleep Rec" with mic waveform icon instead of "Alarms" with alarm icon
- Tapping the Sleep Rec tab shows the SleepRecordingView
- Empty state is shown when no recordings exist
- All other tabs continue to work correctly
- Alarm ringing full-screen cover no longer appears from ContentView (alarms feature is effectively disabled)
- The app builds and runs without errors
- All new strings are localized

**Priority:** 1
**Dependencies:** Feature 2

---

### 4. Recording Controls UI

Build the interactive recording controls: a large record button with live audio visualization, elapsed time display, and recording state management.

**User Story:**
As a user, I want a simple, beautiful interface to start and stop sleep recording with live audio feedback so I know the recording is working while I fall asleep.

**What to create/modify:**

1. **New file: `Sources/Presentation/SleepRecording/Views/RecordingControlsView.swift`**:
   - Large circular button (80pt diameter) centered on screen
   - **Idle state**: Purple filled circle with mic icon, "Start Recording" label below
   - **Recording state**: Red filled circle with stop icon, pulsing ring animation around it, "Stop Recording" label
   - Around the button: animated concentric rings that pulse with `currentDecibels` (use `.scaleEffect` driven by decibel level, clamped to 0.8-1.5 range)
   - Elapsed time displayed above the button in large monospace font: "02:34:17" (HH:MM:SS)
   - Current decibel level shown as small text below time: "32 dB"

2. **Update `SleepRecordingView.swift`**:
   - Show `RecordingControlsView` when status is `.idle` or `.recording`
   - On first tap: check microphone permission, show alert if denied
   - On start: call `sleepRecordingService.startRecording()`
   - On stop: show confirmation alert "Stop recording and analyze your sleep?", then call `sleepRecordingService.stopRecording()`
   - When status changes to `.analyzing`: show ProgressView with "Analyzing your sleep..."
   - When status changes to `.complete`: navigate to the report view (placeholder for now)
   - Show instructional text above controls when idle: "Place your phone on the nightstand with the microphone facing you"

3. **Update `project.pbxproj`**: Add `RecordingControlsView.swift`

**Acceptance Criteria:**
- Tapping the record button starts recording and the UI transitions to recording state
- Live decibel level animates the concentric rings around the button
- Elapsed time counts up in real-time
- Tapping stop shows a confirmation dialog
- Confirming stop ends the recording and shows "Analyzing..." state
- Microphone permission is requested on first use with explanation
- If permission is denied, an alert directs the user to Settings
- The recording continues when the app goes to background or screen locks
- All strings are localized

**Priority:** 2
**Dependencies:** Feature 3

---

### 5. Sound Event Detection Engine

Create the analysis engine that processes recorded audio to detect snoring, loud sounds, and other events. This runs post-recording to preserve battery during sleep.

**User Story:**
As a user, I want the app to automatically detect and categorize snoring, loud sounds, and quiet periods in my sleep recording so I get meaningful insights without manually listening.

**What to create:**

File: `Sources/Data/Services/SoundEventDetector.swift`

**`SoundEventDetector`** class:

*Detection algorithm (operates on the `decibelSamples` array, 1 sample/second):*
1. Calculate baseline noise floor (median of all samples)
2. **Snoring detection**: sustained sound 8+ dB above baseline for 3-30 seconds, with rhythmic pattern (repeating peaks). Classify as `.snoring`
3. **Loud sound detection**: single sample or short burst (1-3 seconds) that is 20+ dB above baseline. Classify as `.loudSound`
4. **Talking detection**: sustained sound 10+ dB above baseline for 3-15 seconds, without rhythmic pattern. Classify as `.talking`
5. **Silence detection**: extended period (5+ minutes) at or below baseline. Classify as `.silence`
6. Merge adjacent events of the same type that are within 5 seconds of each other
7. Calculate `snoreScore` (0-100): weighted formula based on percentage of night with snoring (40%), average snoring intensity above baseline (30%), number of distinct snoring episodes (30%)

*Method:*
- `func analyze(samples: [Float], recordingDuration: TimeInterval, startDate: Date) -> (events: [SoundEvent], snoreScore: Int)` — pure function, easy to test
- Analysis runs on a background thread, results delivered on main actor

*Integration with SleepRecordingService:*
- After `stopRecording()`, service creates `SoundEventDetector` and calls `analyze()`
- Service sets `status = .analyzing` during analysis
- On completion, service populates the recording's `events` and `snoreScore`, saves to disk, sets `status = .complete`

**Acceptance Criteria:**
- Snoring events detected for sustained elevated sound levels (3+ seconds above baseline)
- Loud sound events detected for sudden spikes (20+ dB above baseline)
- Silence periods detected for extended quiet stretches (5+ minutes)
- Adjacent same-type events within 5 seconds are merged
- Snore Score calculated on 0-100 scale with category: quiet (0-30), moderate (31-60), loud (61-100)
- Analysis completes in <5 seconds for an 8-hour recording (roughly 28,800 samples)
- Unit tests with synthetic sample data verify: snoring detection, loud sound detection, silence detection, event merging, snore score calculation boundaries, edge cases (empty samples, all-silence, all-loud)
- All strings localized

**Priority:** 2
**Dependencies:** Feature 2

---

### 6. Sleep Report View

Create the visual report shown after a recording is analyzed. This is the main value screen - users see their Snore Score, a timeline of the night, and summary statistics.

**User Story:**
As a user, I want to see a comprehensive visual report of my sleep recording showing my Snore Score, a timeline of sound events, and key statistics so I can understand how my night went.

**What to create:**

1. **New file: `Sources/Presentation/SleepRecording/Views/SleepReportView.swift`**:
   - Takes a `SleepRecording` as input
   - **Header**: Date and time range (e.g., "Feb 17 · 11:30 PM - 7:02 AM")
   - **Snore Score** (hero section): Large circular gauge showing score 0-100, color-coded: green (0-30 "Quiet"), yellow (31-60 "Moderate"), red (61-100 "Loud"). Score number in center, category label below
   - **Summary cards** (horizontal scroll): 4 cards — Duration ("7h 32m"), Snoring ("23 min"), Events ("12"), Peak dB ("72 dB"). Each card has icon, value, and label
   - **Timeline chart**: Full-width chart showing decibel levels over the night (Feature 6a chart component below)
   - **Events list**: Scrollable list of detected events with type icon, time, duration, intensity badge. Tappable (playback comes in Feature 7)
   - **Medical disclaimer** at bottom in secondary text
   - **Toolbar**: "Export" button (placeholder, functionality in Feature 9), "Done" button to dismiss

2. **New file: `Sources/Presentation/SleepRecording/Views/SleepTimelineChart.swift`**:
   - SwiftUI Charts `Chart` view
   - X-axis: time of night (show hour labels like "12 AM", "2 AM", "4 AM", "6 AM")
   - Y-axis: decibel level (0 to peak+10)
   - Area chart filled with gradient (green at bottom → yellow → red at top)
   - Event markers overlaid as colored dots/lines at their timestamps
   - Horizontally scrollable for long recordings
   - Interactive: drag to see exact time/dB at cursor position (using `.chartOverlay`)

3. **Update `SleepRecordingView.swift`**:
   - When `status == .complete` and `currentRecording` is set, present `SleepReportView` as a sheet
   - When tapping a recording from history (future feature), also show `SleepReportView`

4. **Update `project.pbxproj`**: Add `SleepReportView.swift` and `SleepTimelineChart.swift`

**Acceptance Criteria:**
- Report shows correct Snore Score with appropriate color (green/yellow/red)
- Summary cards display accurate duration, snoring minutes, event count, peak dB
- Timeline chart renders decibel samples over the full recording period
- Event markers appear at correct positions on the timeline
- Chart is scrollable and interactive (shows time/dB on drag)
- Events list shows all detected events with correct type, time, and intensity
- Medical disclaimer is visible at the bottom
- "Done" button dismisses the report
- All strings are localized
- View renders correctly on all iPhone sizes

**Priority:** 2
**Dependencies:** Feature 5

---

### 7. Audio Highlights Playback

Enable users to listen to the most important moments from their sleep recording — the loudest events, snoring episodes, and other detected sounds.

**User Story:**
As a user, I want to listen to specific moments from my sleep recording, especially the loudest snoring and unusual sounds, so I can hear what I sound like and share clips with my doctor.

**What to create/modify:**

1. **New file: `Sources/Presentation/SleepRecording/Views/AudioHighlightsView.swift`**:
   - Accessed from `SleepReportView` via "Listen to Highlights" button or by tapping an event in the events list
   - **"Top Moments" section**: Top 3 loudest events as large cards with play button, type icon, time, duration, peak dB
   - **Full events list**: All events sorted by intensity (toggle to sort chronologically)
   - Each row: play/pause button, event type icon + label, timestamp, duration, peak dB meter bar

2. **Audio playback** (in `SleepRecordingService` or a new helper):
   - `playHighlight(recording:event:)` — creates `AVAudioPlayer`, seeks to `event.timestamp` in the recording file, plays for `event.duration + 3 seconds` (buffer before and after)
   - `stopPlayback()` — stops current playback
   - `isPlayingHighlight: Bool` and `playingEventId: UUID?` (observable, for UI state)
   - Mini player bar at bottom of `AudioHighlightsView` showing current playback position

3. **Timeline interaction** (update `SleepTimelineChart.swift`):
   - Tapping an event marker on the timeline starts playback of that event

4. **Update `project.pbxproj`**: Add `AudioHighlightsView.swift`

**Acceptance Criteria:**
- "Top Moments" section shows the 3 loudest/most significant events
- Tapping play on any event plays the audio from that exact timestamp
- Audio plays for the event duration plus 3 seconds of buffer
- Play/pause toggle works correctly for each event
- Only one event plays at a time (starting a new one stops the current)
- Events can be sorted by intensity or chronologically
- Tapping an event marker on the timeline chart plays that event
- Playback works with screen locked/app backgrounded
- All strings are localized

**Priority:** 3
**Dependencies:** Feature 6

---

### 8. Recording History List

Build the recording history view that shows all past recordings, allowing users to browse, review, and manage their sleep data over time.

**User Story:**
As a user, I want to see all my past sleep recordings in a list so I can track my patterns, compare nights, and delete old recordings to save space.

**What to create/modify:**

1. **New file: `Sources/Presentation/SleepRecording/Views/RecordingHistoryView.swift`**:
   - Default content of `SleepRecordingView` when recordings exist and status is `.idle`
   - **List of recordings** sorted by date (newest first), grouped by month
   - Each row: date (e.g., "Mon, Feb 17"), time range, duration, snore score as colored badge (green/yellow/red circle with number), event count
   - Tap a recording → present `SleepReportView` as sheet
   - Swipe to delete with confirmation alert: "Delete this recording? The audio file will be permanently removed."
   - **Storage info** at bottom: "X recordings · Y MB used"

2. **Update `SleepRecordingView.swift`**:
   - When `recordings` is not empty and status is `.idle`: show `RecordingHistoryView` as the main content
   - Keep the floating record button visible at bottom-right (FAB style) overlaying the list
   - When status is `.recording`: switch to `RecordingControlsView` (full screen)

3. **Storage management** (in `SleepRecordingService`):
   - `totalStorageUsed: Int64` — sum of all recording file sizes
   - `formattedStorageUsed: String` — e.g., "142 MB"
   - `deleteRecording(_:)` — already exists, removes file + metadata

4. **Update `project.pbxproj`**: Add `RecordingHistoryView.swift`

**Acceptance Criteria:**
- All past recordings appear in the list, newest first
- Each row shows date, time range, duration, snore score badge, event count
- Tapping a recording opens its full SleepReportView
- Swipe-to-delete removes the recording file and metadata with confirmation
- Storage usage displayed at bottom of list
- Floating record button is always accessible from the history view
- Empty state still shows when all recordings are deleted
- All strings are localized

**Priority:** 3
**Dependencies:** Feature 6

---

### 9. Export & Share Recordings

Enable users to export their sleep recordings and analysis reports for sharing with healthcare providers or personal backup.

**User Story:**
As a user, I want to export my sleep recording audio and analysis report so I can share it with my doctor or save it to my files for reference.

**What to modify:**

1. **Update `SleepReportView.swift`** — toolbar export button:
   - "Share" button in toolbar using `ShareLink` or presenting `UIActivityViewController`
   - Share options:
     - **Report summary** (default): Text file with date, duration, snore score, event list with timestamps and types, formatted for readability
     - **Audio file**: The full m4a recording file
     - **Both**: Combined share with report text + audio attachment

2. **Report text format:**
   ```
   SoundScape Sleep Report
   Date: Feb 17, 2026
   Time: 11:30 PM - 7:02 AM
   Duration: 7h 32m
   Snore Score: 45/100 (Moderate)

   Summary:
   - Snoring: 23 minutes across 12 episodes
   - Peak volume: 72 dB at 3:14 AM
   - Loudest event: 8 seconds at 3:14 AM (72 dB)

   Events:
   12:15 AM - Snoring (6s, 54 dB)
   1:02 AM - Loud Sound (2s, 68 dB)
   ...

   Note: This report was generated by SoundScape and is not a medical diagnosis.
   ```

3. **Bulk export** (in `RecordingHistoryView`):
   - "Export All" button in toolbar
   - Exports a zip or folder with all recordings + a combined summary JSON

**Acceptance Criteria:**
- Share button on SleepReportView opens iOS share sheet
- Report text summary is well-formatted and readable
- Audio file can be shared via AirDrop, Messages, Email, Files
- Report includes the medical disclaimer
- "Export All" from history exports all recordings
- All strings are localized

**Priority:** 3
**Dependencies:** Feature 8

---

### 10. Timer-Delayed Recording Start

Allow users to set a delay before recording begins, so the app starts capturing after ambient sounds/music fades out from the sleep timer.

**User Story:**
As a user, I want to set a delay before recording starts so it begins after my sleep sounds fade out, capturing only my actual sleep audio without the ambient sounds I play to fall asleep.

**What to modify:**

1. **Update `SleepRecordingView.swift`** — delay picker:
   - "Delay Start" option visible when status is `.idle`, shown as a row above the record button
   - Preset delay options: None, 15 min, 30 min, 45 min, 1 hour, 1.5 hours, 2 hours (reuse the same preset pattern from `SleepTimerPreset`)
   - When a delay is selected and record is tapped: show countdown "Recording starts in 14:32" with a cancel button
   - Smart integration: when `SleepTimerService` has an active timer, show a special option "Start when sounds stop" — this starts recording automatically when the sleep timer ends and sounds fade out

2. **Update `SleepRecordingService.swift`**:
   - `startRecordingWithDelay(minutes:)` — starts a countdown timer, then calls `startRecording()`
   - `delayRemaining: TimeInterval?` — observable, nil when no delay active
   - `cancelDelay()` — cancels the pending delayed start
   - `startRecordingWhenTimerEnds(sleepTimerService:)` — observes the sleep timer and starts recording when it completes

3. **Visual delay indicator** on record button:
   - Countdown ring animation around the button during delay
   - Button label changes to "Cancel" during delay

**Acceptance Criteria:**
- User can select a delay time before starting recording
- Countdown shows remaining time until recording begins
- "Cancel" button stops the countdown and returns to idle
- Recording starts automatically when delay expires
- "Start when sounds stop" option works with active sleep timer
- Delay continues in background (screen locked)
- All strings are localized

**Priority:** 4
**Dependencies:** Feature 4

---

### 11. Snore Trends Dashboard

Add a trends section that shows how the user's snoring patterns change over time, helping them track whether lifestyle changes or treatments are effective.

**User Story:**
As a user, I want to see how my snoring patterns change over time so I can track whether lifestyle changes, remedies, or treatments are improving my sleep quality.

**What to create:**

1. **New file: `Sources/Presentation/SleepRecording/Views/SnoreTrendsView.swift`**:
   - Shown as a section at the top of `RecordingHistoryView` (collapsible) or as a segmented tab within `SleepRecordingView` ("Recordings" | "Trends")
   - **Weekly Snore Score chart** (bar chart, 7 days): Each bar represents one night's snore score, color-coded (green/yellow/red). Nights with no recording show as empty/gray
   - **Weekly average** with trend indicator: arrow up/down/stable compared to previous week, with delta value
   - **Best night** and **Worst night** highlights: date + score, tappable to view report
   - **30-day average** line if 7+ recordings exist in the last 30 days
   - **Streak counter**: "3 nights recorded" to encourage daily use
   - Empty state (fewer than 3 recordings): "Record 3+ nights to see your trends" with progress dots

2. **Update `project.pbxproj`**: Add `SnoreTrendsView.swift`

**Acceptance Criteria:**
- Weekly chart shows snore scores for the last 7 days
- Bars are color-coded by snore score category
- Weekly average shows with trend arrow compared to previous week
- Best and worst nights are highlighted and tappable
- 30-day average appears when enough data exists
- Empty state shown for insufficient data
- All strings are localized
- Unit tests verify trend calculations (average, best/worst, trend direction)

**Priority:** 4
**Dependencies:** Feature 8

---

## Implementation Notes

**Audio Session Coordination:**
The biggest technical challenge is coordinating the recording audio session with the existing playback session in `AudioEngine`. The existing app uses `.playback` category. Recording requires `.playAndRecord`. The `SleepRecordingService` must reconfigure the session when recording starts and restore it when done. Use `.mixWithOthers` option so ambient sounds keep playing during recording.

**Storage Management:**
Full-night recordings (6-8 hours) at AAC quality can be large. Use compressed format: AAC, mono, 22050 Hz, 32kbps = ~15MB per night. After 30 recordings, that's ~450MB. Consider auto-cleanup suggestions.

**Battery Efficiency:**
Recording with metering at 1 sample/second is battery-efficient. All analysis (snoring detection, event classification) runs post-recording, not in real-time. This avoids battery drain during sleep.

**Files to Modify:**
- `Sources/App/ContentView.swift` — Tab replacement (Alarms → Sleep Rec)
- `Sources/App/SoundScapeApp.swift` — Service registration
- `SoundScape.xcodeproj/project.pbxproj` — New file references and groups

**New Files to Create:**
- `Sources/Domain/Entities/SleepRecording.swift`
- `Sources/Data/Services/SleepRecordingService.swift`
- `Sources/Data/Services/SoundEventDetector.swift`
- `Sources/Presentation/SleepRecording/Views/SleepRecordingView.swift`
- `Sources/Presentation/SleepRecording/Views/RecordingControlsView.swift`
- `Sources/Presentation/SleepRecording/Views/SleepReportView.swift`
- `Sources/Presentation/SleepRecording/Views/SleepTimelineChart.swift`
- `Sources/Presentation/SleepRecording/Views/AudioHighlightsView.swift`
- `Sources/Presentation/SleepRecording/Views/RecordingHistoryView.swift`
- `Sources/Presentation/SleepRecording/Views/SnoreTrendsView.swift`

**Existing Alarm Files (kept but unused):**
The Alarms feature files remain in the project but are no longer wired into the tab bar. They can be cleaned up in a future batch if desired:
- `Sources/Data/Services/AlarmService.swift`
- `Sources/Presentation/Alarms/Views/AlarmsView.swift`
- `Sources/Presentation/Alarms/Views/AlarmRowView.swift`
- `Sources/Presentation/Alarms/Views/AlarmDetailView.swift`
- `Sources/Presentation/Alarms/Views/WeekdaySelector.swift`
- `Sources/Presentation/Alarms/Views/SoundPickerView.swift`
- `Sources/Presentation/Alarms/Views/AlarmRingingView.swift`
- `Sources/Domain/Entities/Alarm.swift`
