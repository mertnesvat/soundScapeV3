---
# Night Agent Configuration
base_branch: master
max_retries: 2
continue_on_failure: true
screenshots: true
feature_timeout: 60

# Visual Quality Gate (v1.6.0)
visual_gate_enabled: true
visual_gate_threshold: 0.7
bundle_id: com.StudioNext.SoundScape

# Action Logging (v1.6.0)
action_logging: true

# Deep Quality Mode (v1.10.0)
deep_quality_mode: true
deep_quality_max_retries: 5
deep_quality_visual_threshold: 0.85
deep_quality_min_test_coverage: 0.7
deep_quality_review_gate: true
deep_quality_checkpoints:
  - post_entity
  - post_repository
  - post_viewmodel
  - post_view
  - post_integration
---

# Feature Queue: SoundScape

Generated by NightPrep Agent on 2026-02-12

## Overview

This batch fixes a critical paywall presentation bug (broken into a service fix and per-view integrations), adds educational science content for binaural beats and noise types, and restructures the tab bar by folding Favorites into the Sounds tab. Translations and tests are embedded within each feature rather than separated.

## Global Requirements

The following requirements apply to ALL features in this batch:

- **Translations**: Every user-facing string must use `String(localized:)` or `LocalizedStringKey` and be added to the existing `Localizable.xcstrings` file at `SoundScape/Resources/Localizable.xcstrings`. The source language is English.
- **Unit Tests**: All new or modified business logic must have corresponding unit tests. Existing tests in `SoundScape/Tests/` must continue to pass. Test files follow the pattern `SoundScape/Tests/<ServiceName>Tests.swift`.
- **Build Verification**: The project must build successfully after each feature: `cd SoundScape && xcodebuild -scheme SoundScape -destination 'platform=iOS Simulator,name=iPhone 17 Pro' build`

## Features

### 1. Make PaywallService Reactive for Sheet Presentation

The `PaywallService` currently stores placement and completion handler when `triggerPaywall()` is called, but has no observable state that views can bind to for presenting a paywall sheet. Only `SettingsView` works because it manages its own `showPaywallSheet` state independently. All other views call `triggerPaywall()` and nothing visible happens.

**User Story:**
As a free user, I want the paywall to appear automatically when I tap any locked premium feature, so that I can see what premium offers and choose to subscribe.

**What needs to change in PaywallService:**
- Add a published/observable boolean property (similar to how `SettingsView` uses `showPaywallSheet`) that becomes `true` when `triggerPaywall()` is called for a non-premium user
- When the user is already premium, `triggerPaywall()` should continue to call the completion immediately without changing the presentation state (this already works)
- When the paywall is dismissed (via `handlePaywallDismissed()`) or a purchase succeeds (via `handlePurchaseSuccess()`), the presentation state should reset to `false`
- The existing `SettingsView` paywall presentation must continue to work exactly as before -- do not break it

**Reference pattern (how SettingsView already works correctly):**
- `SettingsView` has `@State private var showPaywallSheet = false`
- A button sets `showPaywallSheet = true`
- A `.sheet(isPresented: $showPaywallSheet)` presents `OnboardingPaywallView`
- The new PaywallService property should enable the same pattern but driven by `triggerPaywall()` calls from any view

**Acceptance Criteria:**
- `PaywallService` exposes a reactive boolean that becomes `true` when `triggerPaywall()` is called and the user is not premium
- The boolean resets to `false` when `handlePaywallDismissed()` or `handlePurchaseSuccess()` is called
- When the user is premium, `triggerPaywall()` calls completion immediately and does NOT set the boolean to `true`
- Existing `PaywallServiceTests` continue to pass
- New unit tests verify: (a) the boolean changes to `true` on `triggerPaywall()` for non-premium users, (b) it stays `false` for premium users, (c) it resets on dismissal, (d) it resets on purchase success
- All new strings are localized

**Priority:** 1
**Dependencies:** None

---

### 2. Add Paywall Sheet Presentation to SoundsView

The Sounds tab calls `triggerPaywall()` when a free user taps a locked premium sound or exceeds the 6-sound mixer limit, but no paywall sheet ever appears. Now that `PaywallService` exposes a reactive presentation state (Feature 1), `SoundsView` needs to observe it and present the paywall sheet.

**User Story:**
As a free user browsing the Sounds tab, I want to see the paywall when I tap a locked sound or hit the mixer limit, so that I can upgrade to premium and access the content.

**How SettingsView does it (reference):**
- `SettingsView` uses `.sheet(isPresented: $showPaywallSheet)` with `OnboardingPaywallView`
- It passes `onComplete` to dismiss, and injects `OnboardingService`, `PaywallService`, and `SubscriptionService` into the environment

**What should happen in SoundsView:**
- Observe the PaywallService presentation state
- Present `OnboardingPaywallView` as a sheet when the state becomes `true`
- On sheet dismissal, call `handlePaywallDismissed()` on PaywallService
- The paywall triggers for: tapping a locked premium sound, tapping the lock icon on a premium sound, exceeding the 6-sound free mixer limit

**Acceptance Criteria:**
- User taps a locked premium sound on the Sounds tab and sees the paywall sheet appear
- User hits the 6-sound free mixer limit and sees the paywall sheet appear
- Dismissing the paywall returns the user to the Sounds tab with no changes
- Subscribing through the paywall grants immediate access to the tapped sound
- The existing mixer, timer, saved mixes, settings, and ASMR info sheets continue to work
- All new strings are localized

**Priority:** 1
**Dependencies:** Feature 1 (PaywallService reactive state)

---

### 3. Add Paywall Sheet Presentation to BinauralBeatsView

The Binaural Beats tab calls `triggerPaywall()` when a free user selects the premium Gamma brainwave state, but the paywall sheet never appears.

**User Story:**
As a free user exploring binaural beats, I want to see the paywall when I select the locked Gamma state, so that I can upgrade and access all brainwave frequencies.

**What should happen:**
- Observe the PaywallService presentation state in BinauralBeatsView (or in the BrainwaveStateSelectorView sub-view where `triggerPaywall` is called)
- Present `OnboardingPaywallView` as a sheet when the state becomes `true`
- On sheet dismissal, call `handlePaywallDismissed()`

**Acceptance Criteria:**
- User selects the locked Gamma brainwave state card and sees the paywall sheet
- Dismissing the paywall returns the user to the Binaural Beats tab with no changes
- Subscribing through the paywall grants access and selects the Gamma state
- All other brainwave states (Delta, Theta, Alpha, Beta) continue to work for free users
- All new strings are localized

**Priority:** 1
**Dependencies:** Feature 1 (PaywallService reactive state)

---

### 4. Add Paywall Sheet Presentation to AdaptiveView, DiscoverView, InsightsView, and WindDownView

Four additional views call `triggerPaywall()` but never present the paywall sheet. These are grouped together because each integration is small and follows the same pattern.

**User Story:**
As a free user, I want to see the paywall when I tap locked features on the Adaptive, Discover, Insights, or Wind Down tabs, so that I can upgrade and access premium content across the entire app.

**Screens and their triggers:**
- **AdaptiveView**: User taps "Unlock Adaptive Mode" button
- **DiscoverView**: User tries to save a community mix (the `saveMix` function calls `triggerPaywall`)
- **InsightsView**: User taps the premium upsell card or any locked section placeholder
- **WindDownView**: User taps premium content (yoga nidra 10min, premium stories, hypnosis sessions, etc.)

**What should happen in each view:**
- Observe the PaywallService presentation state
- Present `OnboardingPaywallView` as a sheet when the state becomes `true`
- On sheet dismissal, call `handlePaywallDismissed()`

**Acceptance Criteria:**
- User taps "Unlock Adaptive Mode" and sees the paywall sheet
- User tries to save a community mix on Discover and sees the paywall sheet
- User taps the "Unlock Full Analytics" card or any locked section on Insights and sees the paywall sheet
- User taps premium Wind Down content (yoga nidra 10min, stories, hypnosis) and sees the paywall sheet
- Dismissing the paywall on any of these screens returns the user to their previous state
- Subscribing through the paywall grants immediate access to the tapped feature
- Existing paywall in Settings and onboarding continues to work
- All new strings are localized

**Priority:** 1
**Dependencies:** Feature 1 (PaywallService reactive state)

---

### 5. Unit Tests for Paywall Presentation Logic

Comprehensive tests to verify that the paywall presentation flow works correctly end-to-end across the reactive state lifecycle.

**User Story:**
As a developer, I want confidence that the paywall always appears when it should, so that free users never hit a dead-end when tapping locked features.

**What to test:**
- PaywallService reactive state transitions: `false` -> `triggerPaywall()` -> `true` -> `handlePaywallDismissed()` -> `false`
- PaywallService reactive state transitions: `false` -> `triggerPaywall()` -> `true` -> `handlePurchaseSuccess()` -> `false`
- Premium user: `triggerPaywall()` does NOT change the reactive state, calls completion immediately
- Multiple rapid `triggerPaywall()` calls do not cause inconsistent state
- The completion handler is invoked after `handlePurchaseSuccess()` but NOT after `handlePaywallDismissed()`
- Placement context is correctly stored and cleared throughout the lifecycle
- The `showPaywallFromSettings()` convenience method works with the reactive state

**Acceptance Criteria:**
- All new tests pass
- All existing `PaywallServiceTests` continue to pass
- Test coverage for the reactive state lifecycle is comprehensive
- Tests verify both the happy path (purchase success) and the dismissal path

**Priority:** 1
**Dependencies:** Feature 1 (PaywallService reactive state)

---

### 6. Remove Favorites Tab from Tab Bar

The tab bar currently has 8 tabs. The Favorites tab should be removed to reduce clutter. Favorites will be accessible through the Sounds tab instead (Feature 7).

**User Story:**
As a user, I want a cleaner tab bar with fewer tabs, so that navigation feels simpler and less overwhelming.

**What changes:**
- Remove the `favorites` case from the `Tab` enum in `ContentView.swift`
- Remove the `FavoritesView()` tab item from the `TabView` in `ContentView.swift`
- The tab count goes from 8 to 7: Sounds, Binaural, Wind Down, Alarms, Discover, Adaptive, Insights
- The `FavoritesView` file and `FavoritesService` should NOT be deleted -- they will be referenced by the new favorites filter in the Sounds tab (Feature 7)

**Acceptance Criteria:**
- Tab bar shows 7 tabs instead of 8
- There is no Favorites tab visible
- All remaining 7 tabs work correctly and navigate to their correct views
- `FavoritesView.swift` and `FavoritesService` remain in the codebase (not deleted)
- The heart-toggle on sound cards still works everywhere (toggling favorite status is unchanged)
- All new or modified strings are localized
- The app builds and runs without errors

**Priority:** 2
**Dependencies:** Features 1-4 (Paywall fixes should be done first since FavoritesView currently has paywall calls that need to work before it is repurposed)

---

### 7. Add Favorites as a Category Filter in the Sounds Tab

With the Favorites tab removed (Feature 6), users need a way to see their favorited sounds. A "Favorites" filter chip should be added to the `CategoryFilterView` on the Sounds tab. This is a special filter that shows only the user's favorited sounds from all categories.

**User Story:**
As a user, I want to see my favorite sounds as a filter option alongside Noise, Nature, Weather, Fire, Music, and ASMR, so that I can quickly browse just my favorites without leaving the Sounds tab.

**How the current CategoryFilterView works:**
- It shows an "All" chip followed by one chip for each `SoundCategory` case (Noise, Nature, Weather, Fire, Music, ASMR)
- Selecting a chip sets `selectedCategory` to the corresponding `SoundCategory?` value (nil for "All")
- `SoundsViewModel.filteredSounds` filters the sounds list by the selected category

**What should change:**
- A "Favorites" chip should appear in `CategoryFilterView` -- positioned either first (after "All") or last, using a heart icon consistent with the existing favorites heart
- Since favorites is NOT a real `SoundCategory` (it is a user-curated cross-category collection), the filter state needs to accommodate a special "favorites" selection distinct from `SoundCategory?`
- When the Favorites filter is selected, the sound grid shows only sounds that the user has favorited (using `FavoritesService.isFavorite()`)
- The existing favorites section that appears at the top of SoundsView when no category is selected can remain as-is

**Acceptance Criteria:**
- A "Favorites" filter chip with a heart icon appears in the category filter bar
- Tapping it shows only the user's favorited sounds in the grid
- Tapping another category chip (Noise, Nature, etc.) switches back to normal category filtering
- Tapping "All" shows all sounds as before (with the favorites section at the top if favorites exist)
- If no sounds are favorited and the Favorites filter is selected, an appropriate empty state is shown (similar to "No Favorites" with heart.slash icon, as in the current `FavoritesView`)
- Heart-toggling a sound while in the Favorites filter updates the list immediately (unfavoriting removes it from the filtered view)
- All new strings are localized
- Unit tests verify the favorites filter logic in the view model

**Priority:** 2
**Dependencies:** Feature 6 (Remove Favorites tab first, so users are not confused by two ways to access favorites)

---

### 8. Science and Education Data Content

Create the educational content about binaural beats, brainwave states, isochronic tones, white noise, and brown noise. This is the data and content layer -- the view (Feature 9) and navigation entry points (Features 10, 11) are separate.

**User Story:**
As a user, I want access to clear, accurate educational content about the science behind the sounds I listen to, so that I understand how binaural beats, white noise, and brown noise benefit my sleep, focus, and relaxation.

**Content to include:**

1. **Binaural Beats Overview** - What they are (two slightly different frequencies in each ear, brain perceives the difference), why headphones are required, how the brain entrains to the beat frequency
2. **Brainwave States** - Delta (2 Hz, deep sleep), Theta (6 Hz, meditation/creativity), Alpha (10 Hz, relaxed focus), Beta (20 Hz, active concentration), Gamma (40 Hz, peak cognition). For each: what it does, when to use it, expected benefits
3. **Isochronic Tones** - What they are (rhythmic pulses at a single frequency), how they differ from binaural beats (no headphones needed), when to use each type
4. **White Noise** - How it helps with sleep, masking disturbances, research-backed focus benefits, safe listening guidance
5. **Brown Noise** - What makes it different from white noise (deeper, lower frequency emphasis), sleep and relaxation benefits, why some prefer it, the app's regular and deep brown noise options

**Acceptance Criteria:**
- All educational content is defined as localizable data (not hardcoded English strings)
- Content is organized into logical sections that a view can iterate over
- All text uses `String(localized:)` or `LocalizedStringKey`
- All new strings are added to `Localizable.xcstrings`
- Content is accurate and accessible to non-technical users
- Unit tests verify the content data is non-empty and structured correctly

**Priority:** 3
**Dependencies:** None

---

### 9. Science View in Settings

Create the science education view that displays the content from Feature 8, and add it as a row in the Settings menu.

**User Story:**
As a user, I want to find a "Sound Science" section in Settings where I can learn about binaural beats, white noise, and brown noise in a well-organized, scannable format.

**Where it lives:**
- A new row in `SettingsView`, placed between the "Social" section and the "About" section
- Tapping it opens a scrollable educational view

**Visual style:**
- Follow the pattern established by `ASMRInfoView` (located at `SoundScape/Sources/Presentation/Components/ASMRInfoView.swift`)
- Use the same NavigationStack + ScrollView + VStack structure
- Use the app's dark theme styling
- Include relevant SF Symbols icons for each section (brain, waveform, headphones, moon, etc.)
- Content should be organized in clearly labeled sections with headers
- Keep text concise and scannable -- bullet points over paragraphs
- Use expandable sections (DisclosureGroup) or a scrollable list with clear headers

**Acceptance Criteria:**
- User can find a "Sound Science" entry in the Settings list (between Social and About sections)
- The entry has an appropriate icon (book or brain symbol)
- Tapping it opens a scrollable view with all educational content from Feature 8
- Content covers: binaural beats overview, all five brainwave states, isochronic tones, white noise benefits, brown noise benefits
- The view follows the app's existing dark theme and visual patterns (like ASMRInfoView)
- Content renders well on all iPhone screen sizes
- A "Done" button in the toolbar dismisses the view
- All text content is localized
- The Settings list still shows all existing rows (Display, Premium, Social, About) correctly

**Priority:** 3
**Dependencies:** Feature 8 (Science content data)

---

### 10. Info Button in Binaural Beats View for Science Section

Add an info button (circle-i icon) to the Binaural Beats view navigation bar that opens the science view, scrolled or navigated to the binaural beats section.

**User Story:**
As a user exploring binaural beats, I want a quick way to learn about how binaural beats and brainwave states work, directly from the Binaural Beats screen.

**How the ASMR info button works (reference pattern):**
- `SoundsView` shows an info.circle button in the toolbar when the ASMR category is selected
- Tapping it opens `ASMRInfoView` as a sheet
- On first visit to the ASMR category, the info sheet auto-opens (using `ASMRInfoService.hasSeenInfo`)

**What should happen for binaural beats:**
- An info.circle button should appear in the `BinauralBeatsView` navigation toolbar (always visible, not conditional)
- Tapping it opens the science view (from Feature 9) as a sheet, ideally showing the binaural beats section
- No auto-open behavior is needed (unlike ASMR)

**Acceptance Criteria:**
- An info button (circle-i icon) is always visible in the Binaural Beats view toolbar
- Tapping it opens the science education content as a sheet
- The content shows binaural beats and brainwave state information
- The button does not interfere with existing Binaural Beats view controls
- All new strings are localized

**Priority:** 3
**Dependencies:** Feature 9 (Science view must exist before it can be linked)

---

### 11. Favorites Filter Empty State

When the user selects the Favorites filter chip (Feature 7) but has no favorited sounds, an appropriate empty state should be displayed.

**User Story:**
As a user who has not favorited any sounds yet, I want to see a helpful empty state when I select the Favorites filter, so that I understand how to add favorites.

**Reference pattern (existing empty state):**
- The current `FavoritesView` shows a `ContentUnavailableView` with "No Favorites", `heart.slash` icon, and "Tap the heart on sounds to add favorites" description

**What should happen:**
- When the Favorites filter is selected in `CategoryFilterView` and no sounds are favorited, show a `ContentUnavailableView` with the same messaging
- The empty state should be centered in the content area (replacing the sound grid)
- Tapping another filter chip should switch away from the empty state

**Acceptance Criteria:**
- Selecting the Favorites filter with zero favorited sounds shows "No Favorites" empty state
- The empty state includes the heart.slash icon and helpful description text
- Switching to another category filter hides the empty state and shows sounds
- When the user favorites a sound while the Favorites filter is active, the sound appears immediately
- All strings in the empty state are localized

**Priority:** 2
**Dependencies:** Feature 7 (Favorites filter chip must exist first)
