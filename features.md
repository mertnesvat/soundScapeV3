---
base_branch: master
max_retries: 5
continue_on_failure: false
visual_gate_enabled: true
visual_gate_threshold: 0.85
bundle_id: com.StudioNext.SoundScape
action_logging: true
deep_quality_mode: true
deep_quality_max_retries: 5
deep_quality_visual_threshold: 0.85
deep_quality_min_test_coverage: 0.7
---

# Feature Queue: SoundScape Paywall & Subscription

Generated by NightPrep Agent on 2026-02-04

## Overview

This batch completes the native StoreKit 2 paywall implementation for SoundScape. The work includes finishing the PaywallService configuration, integrating the paywall screen into the onboarding flow, reviewing the subscription business logic for correctness, and adding comprehensive tests.

## Existing Context

The codebase already has:
- `SubscriptionService.swift` - StoreKit 2 implementation with monthly/yearly product IDs
- `PaywallService.swift` - Wrapper service for paywall triggering and analytics
- `OnboardingPaywallView.swift` - Basic paywall UI (exists but may need integration)
- `OnboardingContainerView.swift` - 10-step onboarding flow (paywall not yet integrated as a step)
- `PremiumManager.swift` - Feature gating logic for premium content
- `SubscriptionServiceTests.swift` - Basic test coverage exists
- `PaywallServiceTests.swift` - Basic test coverage exists

## Features

### 1. Complete Paywall View with Subscription Products

Users can view and purchase subscription plans directly from the paywall screen.

**User Story:**
As a user viewing the paywall, I want to see the actual subscription prices and options from the App Store so that I can make an informed decision about which plan to choose.

**Acceptance Criteria:**
- User sees both subscription options: monthly and yearly
- User sees real prices fetched from App Store Connect (not hardcoded "$4.99/month")
- User sees the yearly savings compared to monthly (e.g., "Save 50%")
- User can tap to purchase either plan
- User sees a loading indicator while purchase is processing
- User sees clear error messages if purchase fails
- User can tap "Restore Purchases" to restore previous subscriptions
- Purchase buttons are disabled while loading to prevent double-taps

**Edge Cases to Consider:**
- Products fail to load from App Store - show retry option
- User cancels purchase mid-flow
- Purchase is pending parental approval
- Network connectivity issues during purchase
- StoreKit sandbox testing environment behavior

**Apple Compliance Requirements:**
- Terms of Use link must be visible and tappable: http://studionext.co.uk/soundscape-terms.html
- Privacy Policy link must be visible and tappable: https://studionext.co.uk/soundscape-privacy.html
- Auto-renewal terms must be clearly stated
- Restore Purchases must be easily accessible

**Priority:** 1
**Dependencies:** None

---

### 2. Integrate Paywall into Onboarding Flow

Users see the paywall as the final step of onboarding before entering the main app.

**User Story:**
As a new user completing onboarding, I want to see a paywall offering premium features so that I can choose to subscribe or continue with free access.

**Acceptance Criteria:**
- Paywall appears as the final step after "Custom Plan" screen
- User can subscribe and continue to main app
- User can dismiss paywall and continue with limited (free) access
- Paywall only shows once during onboarding (not on subsequent app launches)
- If user is already premium, skip directly to main app
- Progress bar shows paywall as final step (if shown)
- User can navigate back from paywall to previous onboarding steps

**Flow Requirement:**
Current: Welcome -> Quiz Goal -> Quiz Challenges -> Analysis -> Results -> Pain Points -> Benefits -> Reviews -> Features -> Custom Plan -> (triggerPaywall) -> Main App

Required: Welcome -> Quiz Goal -> Quiz Challenges -> Analysis -> Results -> Pain Points -> Benefits -> Reviews -> Features -> Custom Plan -> Paywall Screen -> Main App

**Priority:** 2
**Dependencies:** Complete Paywall View with Subscription Products

---

### 3. Review and Fix Subscription Service Business Logic

The subscription service handles real money transactions and must be bug-free.

**User Story:**
As a paying user, I want my subscription status to be accurately tracked so that I always have access to the premium features I paid for.

**Acceptance Criteria:**
- Subscription status persists correctly across app launches
- Expired subscriptions are detected and handled gracefully
- Transaction listener properly handles renewal transactions
- Concurrent purchase attempts are prevented
- Race conditions in status updates are eliminated
- Cache invalidation works correctly when subscription expires
- Subscription status refreshes appropriately in foreground

**Areas to Review:**
- `loadCachedStatus()` - Does it correctly handle expired cached subscriptions?
- `checkCurrentEntitlements()` - Are all edge cases covered for transaction verification?
- `updateSubscriptionStatus()` - Is there a race condition between cache and live status?
- Transaction listener - Does it properly update status on external purchases (Family Sharing)?
- `purchaseMonthly()/purchaseYearly()` - Are concurrent purchases properly prevented?

**Priority:** 1
**Dependencies:** None

---

### 4. Add Comprehensive Subscription Service Tests

Testing is critical for payment code to ensure no revenue loss or user experience issues.

**User Story:**
As a developer, I want comprehensive tests for the subscription service so that I can confidently make changes without breaking payment functionality.

**Acceptance Criteria:**
- Tests cover all subscription states: none, active, expired
- Tests verify cache loading and saving behavior
- Tests verify expiration detection logic
- Tests verify product ID configuration
- Tests cover error handling for all error types
- Tests verify restore purchases flow
- Tests verify the transaction listener behavior
- Tests use mock UserDefaults for isolation
- Tests do not require actual StoreKit/sandbox transactions
- Minimum 70% code coverage for SubscriptionService

**Test Scenarios to Cover:**
1. Initial state with no subscription
2. Loading cached active subscription that is still valid
3. Loading cached active subscription that has expired
4. Purchasing when products are not loaded
5. Clearing errors
6. Cancel listener cleanup
7. Status caching roundtrip
8. Multiple concurrent purchase attempts (if applicable)

**Priority:** 2
**Dependencies:** Review and Fix Subscription Service Business Logic

---

### 5. Add PaywallService Integration Tests

PaywallService coordinates between SubscriptionService, analytics, and the UI layer.

**User Story:**
As a developer, I want tests for PaywallService to ensure it correctly delegates to SubscriptionService and tracks analytics.

**Acceptance Criteria:**
- Tests verify premium status is correctly delegated from SubscriptionService
- Tests verify paywall trigger calls completion handler appropriately
- Tests verify analytics events are logged for paywall actions
- Tests verify purchase success/error handlers work correctly
- Tests verify restore purchases delegates to SubscriptionService
- Tests cover the debug override behavior in DEBUG builds

**Priority:** 3
**Dependencies:** Add Comprehensive Subscription Service Tests

---

### 6. Implement Paywall Presentation from Settings

Users can access the paywall from Settings to upgrade if they skipped during onboarding.

**User Story:**
As a free user who skipped the onboarding paywall, I want to upgrade to premium from Settings so that I can access premium features at any time.

**Acceptance Criteria:**
- Tapping "Upgrade to Premium" in Settings shows the paywall sheet/modal
- Paywall shows the same subscription options as onboarding paywall
- User can complete purchase from Settings paywall
- User can dismiss paywall and return to Settings
- After successful purchase, Settings shows "Premium Active" status
- Restore Purchases works from Settings paywall

**Note:** The Settings view already has the button infrastructure (`showPaywallFromSettings()` method). This feature ensures the paywall view is properly presented.

**Priority:** 3
**Dependencies:** Complete Paywall View with Subscription Products

---

## Product Identifiers Reference

Configured in App Store Connect (use these exact identifiers):
- Monthly: `com.StudioNext.SoundScape.monthly`
- Yearly: `com.StudioNext.SoundScape.yearly`

## Legal Links Reference

- Terms of Use: http://studionext.co.uk/soundscape-terms.html
- Privacy Policy: https://studionext.co.uk/soundscape-privacy.html

## Key Files Reference

| File | Purpose |
|------|---------|
| `SoundScape/Sources/Data/Services/SubscriptionService.swift` | StoreKit 2 purchase logic |
| `SoundScape/Sources/Data/Services/PaywallService.swift` | Paywall triggering and analytics |
| `SoundScape/Sources/Presentation/Onboarding/Views/OnboardingPaywallView.swift` | Paywall UI |
| `SoundScape/Sources/Presentation/Onboarding/Views/OnboardingContainerView.swift` | Onboarding flow controller |
| `SoundScape/Sources/Presentation/Settings/Views/SettingsView.swift` | Settings with upgrade button |
| `SoundScape/Tests/SubscriptionServiceTests.swift` | Existing tests |
| `SoundScape/Tests/PaywallServiceTests.swift` | Existing tests |

## Notes for Night Agent

1. **Deep Quality Mode is enabled** - Take extra care with payment logic. All edge cases must be handled.

2. **Existing code quality** - The SubscriptionService already follows good patterns (dependency injection for UserDefaults, proper async/await usage). Maintain this quality.

3. **Localization** - Price strings from StoreKit are already localized. Do not hardcode prices.

4. **Debug mode** - PaywallService has `debugPremiumOverride` for testing. Ensure tests handle this correctly.

5. **Visual testing** - The paywall UI must look polished. Use the existing OnboardingButton component for consistency.
